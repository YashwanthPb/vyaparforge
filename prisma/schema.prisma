generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────────────────

enum POStatus {
  OPEN
  PARTIALLY_FULFILLED
  COMPLETED
  CANCELLED
}

enum UnitType {
  NOS
  KG
  MTR
  SET
  LOT
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIALLY_PAID
  PAID
  CANCELLED
}

enum PaymentMode {
  NEFT
  RTGS
  CHEQUE
  UPI
  CASH
}

enum PaymentStatus {
  PENDING
  RECEIVED
  CANCELLED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

enum UserRole {
  ADMIN
  USER
}

enum PartyType {
  CUSTOMER
  SUPPLIER
  BOTH
}

enum PurchaseInvoiceStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
}

// ─── User ────────────────────────────────────────────────────────────

model User {
  id       String   @id @default(cuid())
  email    String   @unique
  name     String
  password String
  role     UserRole @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Division ────────────────────────────────────────────────────────

model Division {
  id   String @id @default(cuid())
  name String @unique // e.g. "Aircraft Division"
  code String @unique // e.g. "AD"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseOrders PurchaseOrder[]
  parties        Party[]
}

// ─── Party ───────────────────────────────────────────────────────────

model Party {
  id                String    @id @default(cuid())
  name              String    @unique
  gstin             String?
  phone             String?
  email             String?
  address           String?
  state             String?
  stateCode         String?
  type              PartyType @default(BOTH)
  receivableBalance Decimal   @default(0) @db.Decimal(14, 2)
  payableBalance    Decimal   @default(0) @db.Decimal(14, 2)
  creditLimit       Decimal?  @db.Decimal(14, 2)
  isHAL             Boolean   @default(false)
  divisionId        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  division         Division?         @relation(fields: [divisionId], references: [id])
  purchaseOrders   PurchaseOrder[]
  invoices         Invoice[]
  purchaseInvoices PurchaseInvoice[]

  @@index([type])
  @@index([isHAL])
  @@index([divisionId])
}

// ─── Purchase Order ──────────────────────────────────────────────────

model PurchaseOrder {
  id           String   @id @default(cuid())
  poNumber     String   @unique
  date         DateTime
  deliveryDate DateTime?
  divisionId   String
  partyId      String?
  status       POStatus @default(OPEN)
  remarks      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  division          Division          @relation(fields: [divisionId], references: [id])
  party             Party?            @relation(fields: [partyId], references: [id])
  lineItems         POLineItem[]
  inwardGatePasses  InwardGatePass[]
  outwardGatePasses OutwardGatePass[]
  invoices          Invoice[]

  @@index([divisionId])
  @@index([partyId])
  @@index([status])
}

// ─── PO Line Item ────────────────────────────────────────────────────

model POLineItem {
  id              String   @id @default(cuid())
  purchaseOrderId String
  partNumber      String
  partName        String
  workOrder       String?
  qtyOrdered      Decimal  @db.Decimal(12, 2)
  qtyReceived     Decimal  @default(0) @db.Decimal(12, 2)
  qtyDispatched   Decimal  @default(0) @db.Decimal(12, 2)
  rate            Decimal  @db.Decimal(12, 2)
  unit            UnitType @default(NOS)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseOrder     PurchaseOrder     @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  inwardGatePasses  InwardGatePass[]
  outwardGatePasses OutwardGatePass[]
  invoiceItems      InvoiceItem[]

  @@index([purchaseOrderId])
  @@index([partNumber])
}

// ─── Inward Gate Pass (HAL sends raw material to us) ─────────────────

model InwardGatePass {
  id              String   @id @default(cuid())
  gpNumber        String   @unique
  date            DateTime
  purchaseOrderId String
  poLineItemId    String
  batchNumber     String?
  qty             Decimal  @db.Decimal(12, 2)
  vehicleNumber   String?
  challanNumber   String?
  remarks         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  poLineItem    POLineItem    @relation(fields: [poLineItemId], references: [id])

  @@index([purchaseOrderId])
  @@index([poLineItemId])
}

// ─── Outward Gate Pass (We deliver fabricated parts to HAL) ──────────

model OutwardGatePass {
  id              String   @id @default(cuid())
  gpNumber        String   @unique
  date            DateTime
  purchaseOrderId String
  poLineItemId    String
  batchNumber     String?
  qty             Decimal  @db.Decimal(12, 2)
  vehicleNumber   String?
  challanNumber   String?
  dispatchDate    DateTime?
  remarks         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  poLineItem    POLineItem    @relation(fields: [poLineItemId], references: [id])
  invoice       Invoice?

  @@index([purchaseOrderId])
  @@index([poLineItemId])
}

// ─── Invoice ─────────────────────────────────────────────────────────

model Invoice {
  id                String        @id @default(cuid())
  invoiceNumber     String        @unique
  date              DateTime
  purchaseOrderId   String?
  partyId           String?
  outwardGatePassId String?       @unique
  subtotal          Decimal       @db.Decimal(12, 2)
  cgst              Decimal       @default(0) @db.Decimal(12, 2)
  sgst              Decimal       @default(0) @db.Decimal(12, 2)
  igst              Decimal       @default(0) @db.Decimal(12, 2)
  totalAmount       Decimal       @db.Decimal(12, 2)
  paidAmount        Decimal       @default(0) @db.Decimal(12, 2)
  balanceDue        Decimal       @default(0) @db.Decimal(12, 2)
  status            InvoiceStatus @default(DRAFT)
  dcNumber          String?
  gatePassNumber    String?
  gatePassDate      DateTime?
  paymentType       String?
  hsnCode           String?       @default("9988")
  remarks           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseOrder   PurchaseOrder?   @relation(fields: [purchaseOrderId], references: [id])
  party           Party?           @relation(fields: [partyId], references: [id])
  outwardGatePass OutwardGatePass? @relation(fields: [outwardGatePassId], references: [id])
  items           InvoiceItem[]
  payments        Payment[]

  @@index([purchaseOrderId])
  @@index([partyId])
  @@index([status])
}

// ─── Invoice Item ────────────────────────────────────────────────────

model InvoiceItem {
  id           String   @id @default(cuid())
  invoiceId    String
  poLineItemId String?
  itemName     String?
  partName     String?
  hsnCode      String?
  unit         String?
  qty          Decimal  @db.Decimal(12, 2)
  rate         Decimal  @db.Decimal(12, 2)
  discount     Decimal  @default(0) @db.Decimal(12, 2)
  amount       Decimal  @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoice    Invoice     @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  poLineItem POLineItem? @relation(fields: [poLineItemId], references: [id])

  @@index([invoiceId])
}

// ─── Purchase Invoice (Materials we buy from suppliers) ──────────────

model PurchaseInvoice {
  id             String                @id @default(cuid())
  invoiceNumber  String
  date           DateTime
  partyId        String
  totalAmount    Decimal               @db.Decimal(12, 2)
  paidAmount     Decimal               @default(0) @db.Decimal(12, 2)
  balanceDue     Decimal               @default(0) @db.Decimal(12, 2)
  paymentStatus  PurchaseInvoiceStatus @default(UNPAID)
  paymentType    String?
  description    String?
  poNumber       String?
  workOrder      String?
  batchNumber    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  party Party @relation(fields: [partyId], references: [id])

  @@index([partyId])
  @@index([paymentStatus])
  @@index([date])
}

// ─── Payment ─────────────────────────────────────────────────────────

model Payment {
  id        String        @id @default(cuid())
  invoiceId String
  amount    Decimal       @db.Decimal(12, 2)
  date      DateTime
  mode      PaymentMode?
  reference String?
  status    PaymentStatus @default(PENDING)
  remarks   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
}

// ─── Company Profile ─────────────────────────────────────────────────

model CompanyProfile {
  id        String @id @default(cuid())
  name      String
  gstin     String @default("")
  address   String @default("")
  phone     String @default("")
  email     String @default("")
  state     String @default("")
  stateCode String @default("")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Audit Log ───────────────────────────────────────────────────────

model AuditLog {
  id       String      @id @default(cuid())
  entity   String
  entityId String
  action   AuditAction
  changes  Json?
  userId   String?

  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([userId])
}
